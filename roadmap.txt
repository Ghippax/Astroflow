# Cosmo Analysis Development Roadmap

This document outlines a concrete roadmap for enhancing the `cosmo_analysis` library, focusing on its core strength: providing a unified interface for comparing multiple simulations and creating automated analysis pipelines.

---

## Milestone 1: Configuration and Analysis Pipeline System
*Goal: Create a flexible configuration system that allows users to define both simulation parameters and analysis workflows.*

### 1.1. Implement YAML-based Configuration
*Focus: Create a system where users can define both technical parameters and analysis workflows in configuration files.*
-   **Action**: Create a new file `config_template.yaml` in the root directory to serve as a template for users.
-   **Action**: Create a new module `src/cosmo_analysis/config.py`.
-   **Action**: In `config.py`, implement a function `load_config(path)` that reads a YAML file (using `PyYAML`) and returns a configuration object. The function should default to loading a user-created `config.yaml` if no path is provided.
-   **Action**: Create two template configuration files:
    
    `config_template.yaml` for technical configuration:
    ```yaml
    paths:
      output_directory: "path/to/your/preferred/output"
      data_files:
        bilcontour: "path/to/bilcontour.txt"
        projection_list: "path/to/outputlist_projection.txt"
    
    simulation_parameters:
      particle_types:
        gas: "PartType0"
        dm: "PartType1"
        star: "PartType4"
      
      gadget_units:
        UnitLength_in_cm: 3.08568e+21
        UnitMass_in_g: 1.989e+43
        UnitVelocity_in_cm_per_s: 100000
      
      arepo_units:
        UnitLength_in_cm: 3.0868e+24
        UnitMass_in_g: 1.989e+43
        UnitVelocity_in_cm_per_s: 100000
    
    plotting_defaults:
      figsize: [8, 8]
      fontsize: 12
      dpi: 300
      default_colormap: "algae"
      save_plots: true
      show_plots: false
    
    cosmology:
      hubble_constant: 0.702
      omega_matter: 0.272
      omega_lambda: 0.728
      omega_curvature: 0.0
    ```

    `workflow_template.yaml` for defining analysis pipelines:
    ```yaml
    workflows:
      basic_comparison:
        plots:
          - type: projection
            field: Density
            axes: [0, 1]
            colormap: "algae"
            width: 30  # kpc
          - type: phase
            x_field: Density
            y_field: Temperature
            weight_field: Masses
            limits:
              x: [1e-29, 1e-21]
              y: [1e1, 1e7]
          - type: profile
            x_field: particle_position_cylindrical_radius
            y_field: Masses
            bins: 50
            x_range: [0, 15]
      
      detailed_gas:
        plots:
          - type: density_projection
            width: 30
          - type: temperature_projection
            width: 30
          - type: metallicity_map
            width: 30
          - type: rotation_curve
            max_radius: 15
          - type: velocity_dispersion
            max_radius: 15
    ```

### 1.2. Refactor Code to Use the Configuration
-   **Action**: In `src/cosmo_analysis/io/load.py`, `plot/plots.py`, and `core/fields.py`, import the configuration object.
-   **Action**: Replace all hardcoded particle type strings (e.g., `"PartType0"`, `gasPart`) with lookups from the config object (e.g., `config['simulation_parameters']['particle_types']['gas']`).
-   **Action**: In `plot/plots.py`, modify all plotting functions to remove global-state arguments like `saveFig=saveAll`, `showFig=showAll`, and `verbose=verboseLevel`. These should become explicit boolean arguments, e.g., `save_fig: bool = False`, `show_fig: bool = True`.
-   **Action**: Modify the `handleFig` function to accept a full `output_filepath` as an argument. Remove the dependency on the global `savePath`.
-   **Action**: Deprecate and delete `src/cosmo_analysis/core/constants.py`. Its purpose is fully replaced by the new configuration system.

### 1.3. Remove Hardcoded Paths
-   **Action**: In `src/cosmo_analysis/core/sim_prop.py`, modify `findCenter4` and `findCenter7` to accept `projPath` as a function argument instead of using a hardcoded relative or absolute path.
-   **Action**: In `src/cosmo_analysis/plot/plots.py`, modify `plotKScil` and `plotKSmock` to load the `bilcontour.txt` file from a path specified in the configuration file, not from the local directory.

---

## Milestone 2: Plot Function Library and Workflow Engine
*Goal: Create a robust and flexible plotting library with a powerful workflow engine for automated analysis.*

### 2.1. Enhanced Plot Function Library
-   **Action**: Create a new module `src/cosmo_analysis/plot/plotlib.py` containing standardized plotting functions:
    ```python
    def create_multi_panel(
        simulations: List[Simulation],
        snapshots: List[int],
        plot_funcs: List[Callable],
        shared_args: dict = None,
        layout: Tuple[int, int] = None
    ) -> Figure:
        """Creates a multi-panel figure comparing multiple simulations."""
        
    def projection_panel(
        simulations: List[Simulation],
        snapshots: List[int],
        field: str,
        axes: List[int] = [0, 1],
        **plot_kwargs
    ) -> Figure:
        """Creates a projection panel comparing simulations."""
        
    def phase_panel(
        simulations: List[Simulation],
        snapshots: List[int],
        x_field: str,
        y_field: str,
        weight_field: str = None,
        **plot_kwargs
    ) -> Figure:
        """Creates a phase space panel comparing simulations."""
    ```
-   **Action**: Refactor existing plot functions to use these base functions, ensuring consistent interfaces and error handling.
-   **Action**: Add comprehensive validation of input parameters to catch configuration errors early.

### 2.2. Workflow Engine Implementation
-   **Action**: Create a new module `src/cosmo_analysis/workflow/engine.py`:
    ```python
    class WorkflowEngine:
        def __init__(self, config_path: str):
            self.config = load_workflow_config(config_path)
            self.plot_registry = {
                'projection': plotlib.projection_panel,
                'phase': plotlib.phase_panel,
                'profile': plotlib.profile_panel,
                # Add more plot types
            }
        
        def run_workflow(
            self,
            workflow_name: str,
            simulations: List[Simulation],
            snapshots: List[int],
            output_dir: str = None
        ):
            """Executes a predefined workflow on the given simulations."""
    ```
-   **Action**: Create a workflow registry that maps workflow names to their configurations
-   **Action**: Add validation to ensure all required plot parameters are provided
-   **Action**: Implement automatic output organization by workflow name

### 2.3. Create Standard Analysis Workflows
-   **Action**: Create a library of standard analysis workflows in `src/cosmo_analysis/workflow/standard.py`:
    ```python
    STANDARD_WORKFLOWS = {
        'gas_analysis': {
            'description': 'Complete gas property analysis',
            'plots': [
                {'type': 'projection', 'field': 'Density'},
                {'type': 'projection', 'field': 'Temperature'},
                {'type': 'phase', 'x': 'Density', 'y': 'Temperature'},
                {'type': 'profile', 'x': 'radius', 'y': 'circular_velocity'}
            ]
        },
        'star_formation': {
            'description': 'Star formation analysis',
            'plots': [
                {'type': 'sfr_history'},
                {'type': 'ks_relation'},
                {'type': 'metallicity_distribution'}
            ]
        }
    }
    ```
-   **Action**: Create documentation explaining each workflow and its outputs
-   **Action**: Add example notebooks demonstrating workflow customization

---

## Milestone 3: Interactive Tools and Documentation
*Goal: Enhance the interactive experience while maintaining the focus on multi-simulation comparison.*

### 3.1. Interactive Workflow Builder
-   **Action**: Create a new module `src/cosmo_analysis/interactive/workflow_builder.py`:
    ```python
    class WorkflowBuilder:
        def __init__(self):
            self.available_plots = {
                'projection': {'fields': ['Density', 'Temperature', ...],
                             'parameters': ['width', 'colormap', ...]},
                'phase': {...},
                'profile': {...}
            }
        
        def launch_builder(self):
            """Launch an interactive workflow builder in Jupyter."""
            # Creates widgets for building workflow configurations
            # Outputs YAML configuration
    ```
-   **Action**: Create helper functions for previewing workflow results
-   **Action**: Add workflow validation and testing tools

### 3.2. Result Analysis and Comparison Tools
-   **Action**: Create tools for analyzing differences between simulations:
    ```python
    def compute_simulation_differences(
        sims: List[Simulation],
        snapshots: List[int],
        fields: List[str],
        method: str = 'relative'  # or 'absolute'
    ) -> Dict[str, np.ndarray]:
        """Compute differences between simulations for specified fields."""
    
    def plot_difference_maps(
        differences: Dict[str, np.ndarray],
        **plot_kwargs
    ) -> Figure:
        """Create visualizations of differences between simulations."""
    ```
-   **Action**: Add statistical analysis tools for comparing simulations
-   **Action**: Create automated report generation for simulation comparisons

### 3.3. Documentation and Examples
-   **Action**: Create comprehensive documentation:
    - Installation and setup guide
    - Configuration file reference
    - Workflow creation guide
    - Plot function reference
    - Common analysis patterns
    
-   **Action**: Create example notebooks focusing on workflow-based analysis:
    - `01_basic_workflow.ipynb`: Creating and running simple workflows
    - `02_custom_workflow.ipynb`: Creating custom analysis pipelines
    - `03_interactive_analysis.ipynb`: Using interactive tools
    - `04_simulation_comparison.ipynb`: Detailed simulation comparison
    
-   **Action**: Add function documentation emphasizing:
    - Input parameter validation
    - Common usage patterns
    - Performance considerations
    - Known limitations

---

## Milestone 4: Continuous Integration, Automated Testing, and Community Plugins
*Goal: Enhance code quality, streamline development, and foster community contributions.*

### 4.1. Continuous Integration Setup
- **Action**: Integrate CI pipelines using GitHub Actions (or an equivalent CI tool) to run automated tests, linting, and code coverage on every commit.
- **Action**: Set up a comprehensive testing framework with `pytest` and create a `tests/` directory containing sample tests and benchmarks.
- **Action**: Configure pre-commit hooks with tools like `flake8`, `black`, and `isort` to enforce consistent code quality and style.

### 4.2. Performance and Benchmarking
- **Action**: Develop benchmarking tools and performance monitoring modules to assist developers in optimizing their code.
- **Action**: Document best practices for performance tuning, resource management, and scalability considerations.

---
